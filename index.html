<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Source Music Listener</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-color: #1DB954;
            --text-color: #ffffff;
            --text-secondary-color: #b3b3b3;
            --border-color: #2c2c2c;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        #search-panel {
            width: 380px;
            min-width: 300px;
            max-width: 70%;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            padding: 24px;
            box-sizing: border-box;
        }
        
        #resizer {
            width: 5px;
            cursor: col-resize;
            background-color: var(--border-color);
            transition: background-color 0.2s ease;
        }

        #resizer:hover {
            background-color: var(--primary-color);
        }

        #search-panel h1 {
            margin: 0 0 24px 0;
            font-size: 1.5em;
            color: var(--primary-color);
        }

        .search-controls {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 24px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            margin-bottom: 8px;
            font-size: 0.9em;
            color: var(--text-secondary-color);
        }

        #source-select, #search-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--surface-color);
            color: var(--text-color);
            font-size: 1em;
            box-sizing: border-box;
        }

        #search-button {
            padding: 12px;
            border-radius: 8px;
            border: none;
            background-color: var(--primary-color);
            color: var(--bg-color);
            font-weight: 600;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #search-button:hover {
            background-color: #1ed760;
        }
        
        #search-button:disabled {
            background-color: #535353;
            cursor: not-allowed;
        }

        #results-container {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--surface-color);
            position: relative;
        }

        #results-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        #results-list li {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        #results-list li:last-child {
            border-bottom: none;
        }

        #results-list li:hover {
            background-color: #2a2a2a;
        }

        #results-list li.playing {
            background-color: rgba(29, 185, 84, 0.2);
            color: var(--primary-color);
            font-weight: 600;
        }

        .track-title {
            font-weight: 500;
            display: block;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-creator {
            font-size: 0.85em;
            color: var(--text-secondary-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #player-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 24px;
            box-sizing: border-box;
            overflow: hidden; /* Prevent content from spilling during resize */
        }
        
        #visualizer-container {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--surface-color);
            border-radius: 12px;
            margin-bottom: 24px;
            position: relative;
        }
        
        #visualizer {
            width: 100%;
            height: 100%;
            border-radius: 12px;
        }

        #player-info {
            text-align: center;
            padding: 16px 0;
            min-height: 60px;
        }

        #now-playing-title {
            font-size: 1.5em;
            font-weight: 600;
            margin: 0 0 8px 0;
        }

        #now-playing-creator {
            font-size: 1em;
            color: var(--text-secondary-color);
        }
        
        #audio-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }
        
        #play-pause-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background-color: var(--primary-color);
            color: var(--bg-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
        }
        
        .loader,
        .loader:after {
          border-radius: 50%;
          width: 10em;
          height: 10em;
        }
        .loader {
          font-size: 5px;
          position: absolute;
          top: 50%;
          left: 50%;
          margin-left: -5em;
          margin-top: -5em;
          text-indent: -9999em;
          border-top: 1.1em solid rgba(255, 255, 255, 0.2);
          border-right: 1.1em solid rgba(255, 255, 255, 0.2);
          border-bottom: 1.1em solid rgba(255, 255, 255, 0.2);
          border-left: 1.1em solid #ffffff;
          transform: translateZ(0);
          animation: load8 1.1s infinite linear;
          display: none; /* Hidden by default */
        }
        @keyframes load8 {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>

    <div class="container">
        <div id="search-panel">
            <h1>Open Listener</h1>
            <div class="search-controls">
                <div class="input-group">
                    <label for="source-select">Source de musique</label>
                    <select id="source-select">
                        <option value="internet-archive">Internet Archive</option>
                        <option value="musopen">Musopen</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="search-input">Rechercher Artiste, Chanson, etc.</label>
                    <input type="text" id="search-input" placeholder="ex: Beethoven, Mozart">
                </div>
                <button id="search-button">Rechercher</button>
            </div>
            <div id="results-container">
                <div id="loader" class="loader">Loading...</div>
                <ul id="results-list">
                    <li style="text-align: center; color: var(--text-secondary-color);">Commencez par une recherche.</li>
                </ul>
            </div>
        </div>
        <div id="resizer"></div>
        <div id="player-panel">
            <div id="visualizer-container">
                <canvas id="visualizer"></canvas>
            </div>
            <div id="player-info">
                <h2 id="now-playing-title">Aucune lecture</h2>
                <p id="now-playing-creator">Sélectionnez un morceau dans la liste</p>
            </div>
             <div id="audio-controls">
                <button id="play-pause-button">&#9658;</button>
            </div>
        </div>
    </div>

    <audio id="audio-player" crossOrigin="anonymous"></audio>

    <script>
        // DOM Elements
        const searchPanel = document.getElementById('search-panel');
        const resizer = document.getElementById('resizer');
        const sourceSelect = document.getElementById('source-select');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const resultsList = document.getElementById('results-list');
        const audioPlayer = document.getElementById('audio-player');
        const visualizerCanvas = document.getElementById('visualizer');
        const nowPlayingTitle = document.getElementById('now-playing-title');
        const nowPlayingCreator = document.getElementById('now-playing-creator');
        const playPauseButton = document.getElementById('play-pause-button');
        const loader = document.getElementById('loader');

        // Web Audio API setup
        let audioContext;
        let analyser;
        let sourceNode;
        let isPlaying = false;
        let currentPlayingLi = null;

        const canvasCtx = visualizerCanvas.getContext('2d');

        function setupAudioContext() {
            if (audioContext) return;
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                sourceNode = audioContext.createMediaElementSource(audioPlayer);
                sourceNode.connect(analyser);
                analyser.connect(audioContext.destination);
            } catch (e) {
                showError('Web Audio API is not supported in this browser');
                console.error(e);
            }
        }

        // Search Logic
        searchButton.addEventListener('click', async () => {
            const query = searchInput.value.trim();
            const source = sourceSelect.value;
            if (!query) {
                showError('Veuillez entrer un terme de recherche.');
                return;
            }

            resultsList.innerHTML = '';
            searchButton.disabled = true;
            loader.style.display = 'block';

            try {
                let tracks = [];
                if (source === 'internet-archive') {
                    tracks = await searchInternetArchive(query);
                } else if (source === 'musopen') {
                    tracks = await searchInternetArchive(`creator:(${query}) AND collection:(musopen)`);
                }
                renderResults(tracks);
            } catch (error) {
                console.error('Search failed:', error);
                resultsList.innerHTML = '<li style="text-align: center; color: var(--text-secondary-color);">Erreur lors de la récupération des résultats.</li>';
            } finally {
                searchButton.disabled = false;
                loader.style.display = 'none';
            }
        });

        async function searchInternetArchive(query) {
            const searchUrl = `https://archive.org/advancedsearch.php?q=creator:(${encodeURIComponent(query)}) AND mediatype:(audio)&fl[]=identifier,title,creator&rows=50&output=json`;
            const response = await fetch(searchUrl);
            if (!response.ok) {
                throw new Error('Failed to fetch from Internet Archive');
            }
            const data = await response.json();
            if (!data.response || !data.response.docs) {
                return [];
            }
            return data.response.docs.map(doc => ({
                id: doc.identifier,
                title: doc.title || 'Untitled',
                creator: doc.creator || 'Unknown Artist',
                source: 'internet-archive'
            }));
        }

        function renderResults(tracks) {
            resultsList.innerHTML = '';
            if (tracks.length === 0) {
                resultsList.innerHTML = '<li style="text-align: center; color: var(--text-secondary-color);">Aucun résultat trouvé.</li>';
                return;
            }
            tracks.forEach(track => {
                const li = document.createElement('li');
                li.dataset.id = track.id;
                li.dataset.title = track.title;
                li.dataset.creator = track.creator;
                
                const titleSpan = document.createElement('span');
                titleSpan.className = 'track-title';
                titleSpan.textContent = track.title;
                
                const creatorSpan = document.createElement('span');
                creatorSpan.className = 'track-creator';
                creatorSpan.textContent = track.creator;

                li.appendChild(titleSpan);
                li.appendChild(creatorSpan);

                li.addEventListener('click', () => playTrack(li));
                resultsList.appendChild(li);
            });
        }

        async function getAudioUrlFromArchive(trackId) {
            const metadataUrl = `https://archive.org/metadata/${trackId}`;
            try {
                const response = await fetch(metadataUrl);
                const data = await response.json();
                if (data && data.files) {
                    const audioFiles = data.files.filter(file => 
                        file.format.includes('MP3') || file.format.includes('Ogg Vorbis')
                    );
                    
                    if (audioFiles.length === 0) return null;

                    const vbrFile = audioFiles.find(file => file.format === 'VBR MP3');
                    if (vbrFile) {
                        return `https://archive.org/download/${trackId}/${vbrFile.name}`;
                    }
                    
                    return `https://archive.org/download/${trackId}/${audioFiles[0].name}`;
                }
                return null;
            } catch (error) {
                console.error('Failed to fetch metadata:', error);
                return null;
            }
        }

        async function playTrack(li) {
            setupAudioContext();
            
            if (currentPlayingLi) {
                currentPlayingLi.classList.remove('playing');
            }
            li.classList.add('playing');
            currentPlayingLi = li;

            const trackId = li.dataset.id;
            const trackTitle = li.dataset.title;
            const trackCreator = li.dataset.creator;
            
            nowPlayingTitle.textContent = 'Chargement...';
            nowPlayingCreator.textContent = trackCreator;
            loader.style.display = 'block';

            const audioUrl = await getAudioUrlFromArchive(trackId);
            
            loader.style.display = 'none';

            if (!audioUrl) {
                showError('Fichier audio non trouvé pour ce morceau.');
                li.classList.remove('playing');
                nowPlayingTitle.textContent = 'Aucune lecture';
                nowPlayingCreator.textContent = 'Sélectionnez un morceau';
                return;
            }

            nowPlayingTitle.textContent = trackTitle;
            
            // CORS proxy removed. Direct request to the audio file.
            // This requires the page to be hosted on a server (like GitHub pages)
            // to avoid local 'null' origin issues.
            audioPlayer.src = audioUrl;
            
            audioPlayer.play().catch(e => {
                console.error("Error playing audio:", e);
                showError("Playback failed. The audio file might be corrupt, unavailable, or blocked by CORS.");
                li.classList.remove('playing');
            });

            isPlaying = true;
            playPauseButton.innerHTML = '&#10074;&#10074;'; // Pause symbol
            
            visualize();
        }

        // Visualization Logic (Waveform)
        function visualize() {
            if (!isPlaying) {
                canvasCtx.fillStyle = 'var(--surface-color)';
                canvasCtx.fillRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
                return;
            }

            requestAnimationFrame(visualize);

            const bufferLength = analyser.fftSize;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteTimeDomainData(dataArray);

            canvasCtx.fillStyle = 'var(--surface-color)';
            canvasCtx.fillRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);

            canvasCtx.lineWidth = 2;
            canvasCtx.strokeStyle = 'var(--primary-color)';
            canvasCtx.beginPath();

            const sliceWidth = visualizerCanvas.width * 1.0 / bufferLength;
            let x = 0;

            for (let i = 0; i < bufferLength; i++) {
                const v = dataArray[i] / 128.0; // data is 0-255, normalize to 0.0-2.0
                const y = v * visualizerCanvas.height / 2;

                if (i === 0) {
                    canvasCtx.moveTo(x, y);
                } else {
                    canvasCtx.lineTo(x, y);
                }

                x += sliceWidth;
            }

            canvasCtx.lineTo(visualizerCanvas.width, visualizerCanvas.height / 2);
            canvasCtx.stroke();
        }
        
        // Play/Pause Control
        playPauseButton.addEventListener('click', () => {
            if (!audioContext || !audioPlayer.src) {
                return;
            }
            if (isPlaying) {
                audioPlayer.pause();
                playPauseButton.innerHTML = '&#9658;'; // Play symbol
            } else {
                audioPlayer.play();
                playPauseButton.innerHTML = '&#10074;&#10074;'; // Pause symbol
            }
            isPlaying = !isPlaying;
            visualize();
        });

        audioPlayer.addEventListener('ended', () => {
            isPlaying = false;
            playPauseButton.innerHTML = '&#9658;';
            if(currentPlayingLi) {
                currentPlayingLi.classList.remove('playing');
                currentPlayingLi = null;
            }
        });

        // Responsive canvas
        function resizeCanvas() {
            if (!visualizerCanvas.parentElement) return;
            visualizerCanvas.width = visualizerCanvas.parentElement.clientWidth;
            visualizerCanvas.height = visualizerCanvas.parentElement.clientHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Panel Resizing Logic
        let isResizing = false;
        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';

            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', () => {
                isResizing = false;
                document.body.style.cursor = 'default';
                document.body.style.userSelect = 'auto';
                document.removeEventListener('mousemove', handleMouseMove);
                resizeCanvas();
            });
        });

        function handleMouseMove(e) {
            if (!isResizing) return;
            const newWidth = e.clientX;
            const minWidth = parseInt(getComputedStyle(searchPanel).minWidth);
            const maxWidth = parseInt(getComputedStyle(searchPanel).maxWidth) / 100 * window.innerWidth;
            
            if (newWidth > minWidth && newWidth < maxWidth) {
                searchPanel.style.width = `${newWidth}px`;
            }
        }

        // Simple error display
        function showError(message) {
            let errorDiv = document.getElementById('error-message');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.id = 'error-message';
                errorDiv.style.position = 'fixed';
                errorDiv.style.top = '20px';
                errorDiv.style.left = '50%';
                errorDiv.style.transform = 'translateX(-50%)';
                errorDiv.style.backgroundColor = '#d73a49';
                errorDiv.style.color = 'white';
                errorDiv.style.padding = '10px 20px';
                errorDiv.style.borderRadius = '8px';
                errorDiv.style.zIndex = '1001';
                document.body.appendChild(errorDiv);
            }
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 3000);
        }

    </script>
</body>
</html>
